---
# CrowdSec dashboard installation tasks

- name: Add docker.io package
  apt:
    name: docker.io
    state: present
  become: true

# - name: Check if CrowdSec dashboard is up
#   community.general.docker_container_info:
#     name: crowdsec-metabase
#   register: dashboard_setup

- name: Check if CrowdSec dashboard is up
  command: docker ps --format '{{ '{{' }} .Names {{ '}}' }}'
  changed_when: false
  become: true
  register: dashboard_setup

- name: Set CrowdSec dashboard variables
  set_fact:
    crowdsec_dashboard_password: "{{ lookup('env', 'DASHBOARD_PASSWORD') }}"

- name: Setup CrowdSec dashboard
  command: cscli dashboard setup --listen 0.0.0.0 --password {{ crowdsec_dashboard_password }} --yes
  become: true
  when: "'crowdsec-metabase' not in dashboard_setup.stdout"
